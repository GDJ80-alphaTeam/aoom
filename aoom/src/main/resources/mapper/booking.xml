<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alpha.aoom.booking.service.BookingMapper">
	
	<!-- 컬럼 이름 sql조각 -->
	<sql id="booking_col">
		 booking_id
		,room_id
		,user_id
		,stay_people
		,create_date
		,bookstat_code
		,paystat_code
	</sql>

	<!-- 로그인한 사용자의 예약정보 + 숙소정보 조회 -->
	<select id="selectByUserId" parameterType="map" resultType="camelCaseMap">
		SELECT
		     b.booking_id
		    ,b.create_date
		    ,b.room_id 
		    ,r.room_name
		    ,r.user_id  
		    ,r.main_image 
		    ,c.code_name as paystat_name
		    ,c2.code_name as bookstat_code
		    ,bookingDate.start_date
		    ,bookingDate.end_date
		FROM
		    booking b
		LEFT JOIN
		    room r 
		    on b.room_id = r.room_id
		LEFT JOIN 
		    code c
		    on b.paystat_code = c.code_key
		LEFT JOIN 
		    code c2
		    on b.bookstat_code = c2.code_key
		LEFT JOIN    
		    (SELECT
		        booking_id 
		        ,to_char(min(oneday), 'yy-mm-dd') AS start_date
		        ,to_char(max(oneday), 'yy-mm-dd') AS end_date
		    FROM     
		        booking_oneday_price_map
		    WHERE
		    	booking_id = (
		            SELECT 
		                booking_id
		            FROM     
		                booking 
		            WHERE 
		                user_id = #{userId}
		                )
		    GROUP BY
		        booking_id
		    ORDER BY
		        booking_id desc 
		     )  bookingDate
		     ON bookingDate.booking_id = b.booking_id 
		WHERE 
		    b.user_id = #{userId}

	</select>
	

	
	  		
</mapper>