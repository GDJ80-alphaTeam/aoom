<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alpha.aoom.onedayPrice.service.OnedayPriceMapper">
	<!-- 컬럼 이름 sql조각 -->
	<sql id="onedayPrice_col">
		 oneday
		,room_id
		,oneday_price
		,update_date
		,left_people
		,onestat_code
		,create_date
	</sql>
	
	<!-- onedayPrice의 예약상태의 따른 리스트 검색 -->
	<select id="selectByStatCode" parameterType="map" resultType="camelCaseMap">
		SELECT
	    	TO_CHAR(oneday, 'YYYY-MM-DD') AS oneday
	    FROM
	        oneday_price    
	    WHERE 
	        room_id = #{roomId} 
	    	AND onestat_code = #{onestateCode}        
    </select>

    
    <!-- 숙소 등록시 운영일만큼 숙박 가격 추가 -->
    <insert id="insert" parameterType="map">
		INSERT INTO oneday_price(
			 room_id
			,oneday
			,oneday_price
			,left_people
		) VALUES(
			 #{roomId}
			,#{oneday}
			,#{onedayPrice}
			,#{leftPeople}
		)
    </insert>
    
    <!-- 해당 숙소의 하루 숙박 가격 삭제 -->
    <delete id="delete" parameterType="map">
    	DELETE FROM oneday_price
    	WHERE
    		room_id = #{roomId}
    </delete>
    
    <!-- 사용자가 선택한날로부터 예약가능한날짜 표시 -->
    <select id = "selectByOneday" parameterType="map" resultType="camelCaseMap">
    	SELECT 
    		*
   		FROM 
    		oneday_price 
   		WHERE
    		room_id = #{roomId}
    		AND oneday <![CDATA[>=]]> #{selectedDate}
    		AND oneday <![CDATA[<=]]>
        		(SELECT 
        			oneday	     		
        		FROM
		        	(
		        	SELECT
		           		  rownum as rn  
		           		 ,<include refid="onedayPrice_col"/> 
		        	FROM
		            	oneday_price
		        	WHERE 
		        		oneday <![CDATA[>=]]> #{selectedDate}    
		        		AND onestat_code = 'one02'
		        		AND room_Id = #{roomId}        
		        	ORDER BY 
		        		oneday 
		       		)
        		WHERE 
            		rn <![CDATA[>]]> 0 
            		AND rn <![CDATA[<]]> 2 )
        
    </select>
    <!-- 비활성된 예약날짜가 없을시 실행할 쿼리 -->
    <select id = "selectByremain" parameterType="map" resultType="camelCaseMap">
    	
            SELECT
                oneday 
            FROM
            	oneday_price
            WHERE 
                room_id = #{roomId} 
                AND oneday <![CDATA[>=]]> #{selectedDate}
            UNION        
            SELECT  
            	oneday+1
            FROM 
            	oneday_price
            WHERE
              	room_id = #{roomId} 
               	AND oneday <![CDATA[>=]]> #{selectedDate}
        
    </select>
</mapper>