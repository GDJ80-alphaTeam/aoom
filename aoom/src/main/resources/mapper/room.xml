<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alpha.aoom.room.service.RoomMapper">
	
	<!-- 컬럼 이름 sql조각 -->
	<sql id="room_col">
		 r.room_id
		,r.user_id
		,r.room_name
		,r.roomtype_code
		,r.roomcate_code
		,r.default_price
		,r.start_date
		,r.end_date
		,r.address
		,r.roomstat_code
		,r.room_content
		,r.reject_content
		,r.max_people
		,r.total_space
		,r.total_bed
		,r.total_bath
		,r.create_date
		,r.update_date
		,r.main_image
		,r.original_name
		,r.bank_code
		,r.account_no
		,r.views
	</sql>	
	
	<!-- 숙소 전체 목록 조회 retrieveList -->
	<select id="select" resultType="camelCaseMap">
		SELECT
		    <include refid="room_col" />
		FROM
		    room r
		WHERE
			roomstat_code = 'rst03'
	</select>
	
	<!-- 숙소 상세조회 selectOne -->
	<select id="selectOne" parameterType="Map" resultType="camelCaseMap">
		SELECT 
			 <include refid="room_col" />
			,u.user_name
			,u.user_image
		FROM 
			room r	
		LEFT JOIN
			users u
		ON
			r.user_id = u.user_id							
		WHERE 
			r.room_id = #{roomId} 			 
	</select>
			
	<!-- user가 호스팅 중인 숙소 목록 조회 retrieveList -->
	<select id="selectByUserId" parameterType="String" resultType="camelCaseMap">
	    SELECT
	        <include refid="room_col" />,
	        c.code_name
	    FROM
	        room r
	    INNER JOIN 
	    	code c
	    ON 
	    	r.roomstat_code = c.code_key 
        WHERE 
        	user_id = #{userId}
	</select>
	
	<!-- 조회수 TOP4 숙소 조회 -->
	<select id="selectByViews" resultType="camelCaseMap">
		SELECT 
			*
		FROM (
			SELECT
				<include refid="room_col" />
			FROM
				room r
			ORDER BY 
				r.views DESC
		) r
		WHERE 
			ROWNUM <![CDATA[<=]]> 4 AND
			roomstat_code = 'rst03'
	</select>
	
	<!-- 별점 TOP4 숙소 조회 -->
	<select id="selectByRating" resultType="camelCaseMap">
		SELECT
			<include refid="room_col" />
		FROM
			room r
	    INNER JOIN 
	        (SELECT 
	            room_id
	         FROM (
	             SELECT
	             	 room_id
	             	,ROW_NUMBER() OVER (ORDER BY AVG(rating) DESC) rn
	             FROM 
	             	review
	             GROUP BY 
	             	room_id
	             ) ra
	         WHERE 
	         	rn <![CDATA[<=]]> 4
	         ) s
	     ON
	     	r.room_id = s.room_id
	     WHERE
			roomstat_code = 'rst03'
	</select>
	
	<!-- 예약 TOP4 숙소 조회 -->
	<select id="selectByBooking" resultType="camelCaseMap">
		SELECT
			<include refid="room_col" />
		FROM
			room r
		INNER JOIN(
			SELECT	
				 bc.room_id
				,bc.cnt
			FROM(
				SELECT
					 room_id
					,count(*) cnt
				FROM
					booking
				GROUP BY
					room_id
				) bc
			WHERE
				ROWNUM <![CDATA[<=]]> 4
			) bct
		ON
			r.room_id = bct.room_id
		WHERE
			roomstat_code = 'rst03'
	</select>
	
	<!-- 위시리스트 TOP4 숙소 조회 -->
	<select id="selectByWishList" resultType="camelCaseMap">
		SELECT
		    <include refid="room_col" />
		FROM
		    room r
		INNER JOIN(
		    SELECT
		        w.room_id
		    FROM(
		        SELECT
		             room_id
		            ,count(*)
		        FROM
		            wishlist
		        GROUP BY
		            room_id
		        ) w
		    WHERE
		        ROWNUM <![CDATA[<=]]> 4
		    ) wr
		ON
		    r.room_id = wr.room_id
		WHERE
		    roomstat_code = 'rst03'
	</select>
	
	<!-- 검색, 필터, 카테고리 조건으로 조회 -->
	<select id="selectBySearch" parameterType="map" resultType="camelCaseMap">
		SELECT
			 main_image
			,address
			,room_name
			,default_price
		FROM
			room
		WHERE
			roomstat_code = 'rst03'
	        <if test="address != null and address != ''">
	            AND address LIKE '%' || #{address} || '%' 
	        </if>
	        <if test="selectedCategory != null">
	            AND roomcate_code = #{selectedCategory}
	        </if>
			
	</select>
	
	<!-- 숙소 등록 - 숙소 등록 1단계 전 숙소 초기화 -->
	<insert id="insert" parameterType="map">
 		 <!-- ROOM INSERT 전 사용가능한 roomId가져와서 param에 추가후, INSERT 쿼리에 적용 -->
		 <selectKey keyProperty="roomId" resultType="String" order="BEFORE">
	        SELECT 
	        	'r' || TO_CHAR(SYSDATE, 'YYYYMMDD') || LPAD(NVL(MAX(SUBSTR(room_id, 10, 2)), 0) + 1, 2, '0') AS room_id
	        FROM 
	        	room
	        WHERE 
	        	room_id LIKE 'r' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '%'
	    </selectKey>
		
		INSERT INTO ROOM(
			 room_id
			,user_id
			,roomstat_code
		) VALUES(
			 #{roomId}
			,#{userId}
			,'rst06'
		)
	</insert>
	
	<!-- 숙소 등록 - 숙소 등록 1단계에서 입력한 정보 DB에 업데이트 -->
	<update id="updateBasicInfo" parameterType="map">
		UPDATE
			room
		SET
			 roomtype_code = #{roomtypeCode}
			,roomcate_code = #{roomcateCode}
			,start_date = #{startDate}
			,end_date = #{endDate}
			,address = #{address}
			,max_people = #{maxPeople}
			,total_space = #{totalSpace}
			,total_bed = #{totalBed}
			,total_bath = #{totalBath}
			,update_date = SYSDATE
		WHERE
			room_id = #{roomId}
	</update>
	
	<!-- 숙소 등록 - 숙소 등록 2단계에서 입력한 정보 DB에 업데이트 -->
	<update id="updateDetailInfo" parameterType="map">
		UPDATE
			room
		SET
			 room_name = #{roomName}
			,room_content = #{roomContent}
			,main_Image = #{mainImage}
			,original_name = #{originalName}
			,update_date = SYSDATE
		WHERE
			room_id = #{roomId}
	</update>
</mapper>