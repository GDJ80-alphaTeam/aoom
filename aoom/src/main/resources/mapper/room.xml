<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alpha.aoom.room.service.RoomMapper">
	
	<!-- room테이블 컬럼 모음 sql조각 -->
	<sql id="room_col">
		R.room_id,
		R.user_id,
		R.room_name,
		R.roomtype_code,
		R.roomcate_code,
		R.default_price,
		R.start_date,
		R.end_date,
		R.address,
		R.roomstat_code,
		R.room_content,
		R.reject_content,
		R.max_people,
		R.total_space,
		R.total_bed,
		R.total_bath,
		R.create_date,
		R.update_date,
		R.main_image,
		R.original_name,
		R.bank_code,
		R.account_no,
		R.views
	</sql>	
	
	<!-- 숙소 전체 목록 조회 retrieveList -->
	<select id="retrieveList" resultType="camelCaseMap">
		SELECT
		    <include refid="room_col" />
		FROM
		    ROOM R
	</select>
	
	<select id="retrieveInfo" resultType="camelCaseMap">
		SELECT
			<include refid="room_col" />
		FROM 
			ROOM R
		WHERE 
			room_id = #{roomId} 	
	</select>
	
	<!-- 호스트가 호스팅 중인 숙소 목록 조회 retrieveList -->
	<select id="hostRetriveList" parameterType="String" resultType="camelCaseMap">
	    SELECT
	        <include refid="room_col" />,
	        C.code_name
	    FROM
	        ROOM R
	    INNER JOIN 
	    	CODE C
	    ON 
	    	R.roomstat_code = C.code_key 
        WHERE 
        	USER_ID = #{userId}
	</select>
	
	<!-- 조회수 TOP4 숙소 조회 -->
	<select id="viewsDesc" resultType="camelCaseMap">
		SELECT 
			<include refid="room_col" />
		FROM (
			SELECT
				<include refid="room_col" />
			FROM
				ROOM R
			ORDER BY 
				R.VIEWS DESC
		) R
		WHERE 
			<![CDATA[ROWNUM <= 4]]>
	</select>
	
	<!-- 별점 TOP4 숙소 조회 -->
	<select id="ratingDesc" resultType="camelCaseMap">
		SELECT
			<include refid="room_col" />
		FROM
			room R
	    INNER JOIN 
	        (SELECT 
	            room_id
	         FROM (
	             SELECT
	             	room_id,
	             	AVG(rating) ratingAvg,
	             	ROW_NUMBER() OVER (ORDER BY AVG(RATING) DESC) rn
	             FROM 
	             	review
	             GROUP BY 
	             	room_id
	             ) ra
	         WHERE 
	         	<![CDATA[rn <= 4]]>
	         ) s
	     ON r.room_id = s.room_id
	</select>
</mapper>