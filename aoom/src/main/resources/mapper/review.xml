<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alpha.aoom.review.service.ReviewMapper">
	<!-- 컬럼 이름 sql조각 -->
	<sql id="review_col">
		booking_id
       ,room_id
       ,user_id
       ,review_content
       ,review_image
       ,original_name
       ,create_date
	</sql>
	
	<!-- 숙소 리뷰 목록 조회-->
	<select id="selectByList" parameterType="map" resultType="camelCaseMap">
	 SELECT
        *
        FROM
        ( 
            SELECT 
                ROWNUM as rn 
               ,<include refid="review_col"/>         
            FROM (
                SELECT 
                 <include refid="review_col"/>
                FROM 
                    review
                WHERE 
                    room_id = #{roomId}	 
                ORDER BY create_date DESC  
            )  
         ) r
         LEFT JOIN
            users
         ON
         	r.user_id = users.user_id
         WHERE
			rn <![CDATA[>]]> #{beginRow} and rn <![CDATA[<=]]> #{endRow}
	</select>
	
	<!-- 해당하는 숙소의 리뷰 총 개수 및 총개수rating 평균 -->
	<select id="selectByAverageCount" parameterType="map" resultType="camelCaseMap">
		SELECT 
			 COUNT(*) AS cnt
			,AVG(rating) AS avg		
		FROM 
			review
		WHERE 
			room_id = #{roomId}	
	</select>
	
	<!-- 해당하는 숙소 주인이 받았던 후기 총 개수 -->
	<select id="selectByHostTotalCount" parameterType="map" resultType="camelCaseMap">
		SELECT 
			 COUNT(*) AS cnt 
		    ,avg(rating) AS avg
		FROM
			review
		INNER JOIN
			(
    		SELECT
    			room_id
    		FROM
    			room
    		WHERE
    			user_id =
    			(
    			SELECT 
       				user_id
    			FROM 
        			room
    			WHERE
        			room_id =  #{roomId}
      			)
		) a
		ON 
		review.room_id = a.room_id
		
	</select>
</mapper>