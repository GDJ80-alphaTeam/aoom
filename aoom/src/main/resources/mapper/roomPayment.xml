<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alpha.aoom.roomPayment.service.RoomPaymentMapper">
	<sql id="roomPayment_col">
		 payment_id
		,booking_id
		,room_id
		,user_id
		,paytype_code
		,card_no
		,refund_account
		,payment_price
		,create_date
	</sql>
	
	<!-- 결제 내역 추가  -->
	<insert id="insert" parameterType="map">
		<selectKey keyProperty="paymentId" resultType="String" order="BEFORE">
	        SELECT 
	        	'p' || TO_CHAR(SYSDATE, 'YYYYMMDD') || LPAD(NVL(MAX(SUBSTR(payment_id, 10, 2)), 0) + 1, 2, '0')
	        FROM 
	        	room_payment
	        WHERE 
	        	payment_id LIKE 'p' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '%'
		</selectKey>
		
		INSERT INTO room_payment (
			 PAYMENT_ID
			,BOOKING_ID
			,ROOM_ID
			,USER_ID
			,PAYTYPE_CODE
			,CARD_CODE
			,CARD_NO
			,BANK_CODE
			,REFUND_ACCOUNT
			,PAYMENT_PRICE
			,CREATE_DATE
		) VALUES (
			 #{paymentId}
			,#{bookingId}
			,#{roomId}
			,#{userId}
			<if test="(cardNo != null and !cardNo.equals('')) and (refundAccount == null or refundAccount.equals(''))">
				,'pmt01'
				,#{card}
				,#{cardNo}
				,null
				,null
			</if>
			<if test="(refundAccount != null and !refundAccount.equals('')) and (cardNo == null or cardNo.equals(''))">
				,'pmt02'
				,null
				,null
				,#{bank}
				,#{refundAccount}
			</if>
			,#{paymentPrice}
			,SYSDATE
			)
	</insert>
	
	<!-- 해당예약의 결제정보 검색 -->
	<select id="selectByBookingId" parameterType="map" resultType="camelCaseMap">
		SELECT
	    	<include refid="roomPayment_col"/>
		FROM  
	    	room_payment
		WHERE
	    	booking_id = #{bookingId}
	</select>
	
	<!-- 결제취소시 계좌값이 변동되었다면 변경 -->
	<update id="updateAccount" parameterType="map" >
		UPDATE 
            room_payment
        SET
             refund_account = #{refundAccount}
            ,bank_code = #{bankCode}
        WHERE
            payment_id = #{paymentId}
            AND booking_id = #{bookingId}
            AND refund_account != #{refundAccount}
            AND bank_code != #{bankCode}
	</update>
	
	<!-- 호스트의 수입(전체 or 숙소별) -->
	<select id="selectByHostRevenue" parameterType="map" resultType="camelCaseMap">
	    SELECT
	         TO_CHAR(rp.create_date, 'YYYY-MM') AS payment_month
	        ,SUM(rp.payment_price) AS total_amount
	    FROM
	        room r
	    INNER JOIN
	        room_payment rp
	    ON
	        r.room_id = rp.room_id
	    WHERE
	        r.user_id = #{userId}
	        AND r.roomstat_code = 'rst03'
	        AND rp.paytype_code = 'pmt01'
	        AND rp.booking_id NOT IN (
	            SELECT
	                booking_id
	            FROM
	                cancel_refund
	        )
	        <if test="roomId != null and !roomId.equals('')">
	            AND r.room_id = #{roomId}
	        </if>
	    GROUP BY
	        TO_CHAR(rp.create_date, 'YYYY-MM')
	    ORDER BY
	        payment_month
	</select>

</mapper>